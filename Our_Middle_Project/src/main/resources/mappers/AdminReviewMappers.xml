<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="AdminReviewMappers">

	<select id="selectAllReviews" parameterType="java.lang.String"
		resultType="com.our_middle_project.dto.AdminReviewDTO"> SELECT
		B.BOARD_NO AS boardNo, B.BOARD_TITLE AS boardTitle, B.BOARD_CONTENT AS
		boardContent, M.NICKNAME AS nickname, TO_CHAR(B.CREATED_DATE,
		'YYYY-MM-DD') AS createdDate, S.STAR AS stars, (CASE WHEN EXISTS (SELECT
		1 FROM BOARD_IMAGE I WHERE I.BOARD_NO = B.BOARD_NO) THEN 'Y' ELSE 'N'
		END) AS hasImage, R.REPLY_CONTENT AS adminReply, TO_CHAR(R.CREATE_DATE,
		'YYYY-MM-DD') AS adminReplyDate FROM BOARD B JOIN MEMBER M ON B.MEM_NO =
		M.MEM_NO LEFT JOIN BOARD_STAR S ON B.BOARD_NO = S.BOARD_NO LEFT JOIN
		BOARD_REPLY R ON B.BOARD_NO = R.BOARD_NO AND R.UP_REPLY_NO IS NULL WHERE
		B.TYPE_NO = 2 <if test="_parameter != null and _parameter != ''">
			AND (B.BOARD_TITLE LIKE '%' || #{_parameter} || '%' OR
			M.NICKNAME LIKE '%' || #{_parameter} || '%')
		</if>
		ORDER BY B.CREATED_DATE DESC </select>

	<update id="upsertAdminReply" parameterType="java.util.Map">
		MERGE INTO
		BOARD_REPLY R
		USING (
		SELECT #{boardNo} AS BOARD_NO FROM DUAL
		) D ON
		(R.BOARD_NO = D.BOARD_NO AND R.UP_REPLY_NO IS NULL)
		WHEN MATCHED THEN
		UPDATE SET
		R.REPLY_CONTENT = #{replyContent},
		R.UPDATE_DATE = SYSDATE
		WHERE
		R.BOARD_NO = #{boardNo}
		AND R.UP_REPLY_NO IS NULL
		WHEN NOT MATCHED
		THEN
		INSERT (
		R.REPLY_NO, R.BOARD_NO, R.MEM_NO,
		R.REPLY_CONTENT,
		CREATE_DATE, UPDATE_DATE
		)
		VALUES (
		SEQ_BOARD_REPLY.NEXTVAL, #{boardNo},
		#{adminMemNo},
		#{replyContent}, SYSDATE, SYSDATE
		)
	</update>

	<delete id="deleteAllReviewImagesByBoardNo" parameterType="int">
		DELETE FROM BOARD_IMAGE
		WHERE BOARD_NO = #{boardNo}
	</delete>
	
	<delete id="deleteReviewStars" parameterType="int">
		DELETE FROM
		BOARD_STAR WHERE BOARD_NO = #{boardNo}
	</delete>

	<delete id="deleteReviewReplies" parameterType="int">
		DELETE FROM
		BOARD_REPLY WHERE BOARD_NO = #{boardNo}
	</delete>
	<delete id="deleteReview" parameterType="int">
		DELETE FROM BOARD
		WHERE
		BOARD_NO = #{boardNo} AND TYPE_NO = 2
	</delete>

	<select id="selectReviewImages" parameterType="int"
		resultType="com.our_middle_project.dto.AdminBoardImageDTO">
		SELECT FILE_NO AS fileNo,
		FILE_NAME AS fileName,
		FILE_PATH AS filePath,
		BOARD_NO AS boardNo
		FROM BOARD_IMAGE
		WHERE BOARD_NO = #{boardNo}
		AND TYPE_NO = 2
		ORDER BY
		FILE_NO ASC
	</select>
	
	<resultMap id="ReviewImageMap" type="com.our_middle_project.dto.AdminBoardImageDTO">
  <id     property="fileNo"   column="fileNo"/>
  <result property="fileName" column="fileName"/>
  <result property="filePath" column="filePath"/>
  <result property="boardNo"  column="boardNo"/>
  <result property="uploadDate" column="uploadDate"/>
</resultMap>

	<delete id="deleteReviewImageByFileNo" parameterType="int">
		DELETE FROM BOARD_IMAGE
		WHERE FILE_NO = #{fileNo}
	</delete>

	<delete id="deleteReviewImagesByFileNos" parameterType="list"> DELETE FROM
		BOARD_IMAGE WHERE FILE_NO IN <foreach collection="list" item="no"
			open="(" separator="," close=")">
			#{no}
		</foreach>
	</delete>

	<delete id="deleteBoardDislikes" parameterType="int">
		DELETE FROM
		BOARD_DISLIKE WHERE BOARD_NO = #{boardNo}
	</delete>
</mapper>