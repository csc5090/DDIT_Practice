<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="gameLogMapper">

	<insert id="insertGameLog"
		parameterType="com.our_middle_project.dto.GameLogDTO">
		INSERT INTO GAME_LOG (
		GAME_LOG_NO, SCORE, START_TIME, END_TIME, MEM_NO, LEVEL_NO, COMBO,
		CLEAR_TIME
		)
		VALUES(
		SEQ_GAME_LOG.NEXTVAL, #{score}, #{startTime, jdbcType=TIMESTAMP},
		#{endTime, jdbcType=TIMESTAMP},
		#{memNo}, #{levelNo}, #{combo}, #{clearTime}
		)
	</insert>

	<select id="getTotalGameCount" resultType="int">
		SELECT COUNT(*) FROM GAME_LOG
	</select>

	<select id="getTotalGamesByLevel" resultType="java.util.Map">
		SELECT
		SUM(CASE WHEN LEVEL_NO = 1 THEN 1 ELSE 0 END) AS "LEVEL_1",
		SUM(CASE WHEN LEVEL_NO = 2 THEN 1 ELSE 0 END) AS "LEVEL_2",
		SUM(CASE WHEN LEVEL_NO = 3 THEN 1 ELSE 0 END) AS "LEVEL_3"
		FROM GAME_LOG
	</select>

	<select id="getDailyCumulativeGameStatsForChart" resultType="java.util.Map"
		parameterType="java.util.Map">
		WITH DATES AS (
		SELECT TRUNC(SYSDATE) - LEVEL + 1 AS "date"
		FROM DUAL
		CONNECT BY <![CDATA[ LEVEL <= #{days} ]]>
		)
		SELECT
		TO_CHAR(D."date", 'MM-DD') AS "LABEL",
		(SELECT COUNT(*)
		FROM GAME_LOG G
		WHERE TRUNC(G.START_TIME) <![CDATA[ <= ]]> D."date") AS "VALUE"
		FROM
		DATES D
		ORDER BY
		D."date" ASC
	</select>

	<select id="getDailyPlayCountByLevel" resultType="java.util.Map"
		parameterType="java.util.Map">
		WITH DATES AS (
		SELECT TRUNC(SYSDATE) - LEVEL + 1 AS "date"
		FROM DUAL
		CONNECT BY <![CDATA[ LEVEL <= #{days} ]]>
		)
		SELECT
		TO_CHAR(D."date", 'MM-DD') AS "LABEL",
		COUNT(CASE WHEN G.LEVEL_NO = 1 THEN 1 END) AS "LEVEL_1",
		COUNT(CASE WHEN G.LEVEL_NO = 2 THEN 1 END) AS "LEVEL_2",
		COUNT(CASE WHEN G.LEVEL_NO = 3 THEN 1 END) AS "LEVEL_3"
		FROM
		DATES D
		LEFT JOIN
		GAME_LOG G ON TRUNC(G.START_TIME) = D."date"
		GROUP BY
		D."date"
		ORDER BY
		D."date" ASC
	</select>

	<select id="selectGameBalanceReport" resultType="java.util.Map"
		parameterType="java.util.Map">
		SELECT
		LEVEL_NO AS "levelNo",
		COUNT(*) AS "playCount",
		COUNT(DISTINCT MEM_NO) AS "uniqueUsers",
		AVG(CLEAR_TIME) AS "avgClearTime",
		AVG(SCORE) AS "avgScore",
		MAX(SCORE) AS "maxScore",
		AVG(COMBO) AS "avgCombo",
		MAX(COMBO) AS "maxCombo"
		FROM
		GAME_LOG
		WHERE
		START_TIME BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD')
		AND TO_DATE(#{endDate}, 'YYYY-MM-DD') + 0.99999
		GROUP BY
		LEVEL_NO
		ORDER BY
		LEVEL_NO ASC
	</select>

	<select id="selectDailyActiveUsers" parameterType="java.util.Map"
		resultType="java.util.HashMap">
		WITH DATES AS (
		SELECT TRUNC(SYSDATE) - LEVEL + 1 AS "date"
		FROM DUAL
		CONNECT BY <![CDATA[ LEVEL <= #{days, jdbcType=INTEGER} ]]>
		),
		DAU AS (
		SELECT
		TRUNC(LOG_DATE) AS "log_day",
		COUNT(DISTINCT MEM_NO) AS "user_count"
		FROM GAME_LOG
		WHERE LOG_DATE >= TRUNC(SYSDATE) - #{days, jdbcType=INTEGER} + 1
		GROUP BY TRUNC(LOG_DATE)
		)
		SELECT
		TO_CHAR(D."date", 'MM-DD') AS "LABEL",
		NVL(DAU."user_count", 0) AS "VALUE"
		FROM DATES D
		LEFT JOIN DAU ON D."date" = DAU."log_day"
		ORDER BY D."date" ASC
	</select>

	<select id="getTodayPlayCount" resultType="int">
		SELECT COUNT(*) FROM GAME_LOG WHERE TRUNC(LOG_DATE) = TRUNC(SYSDATE)
	</select>

	<select id="getReturningUserTrend" parameterType="java.util.Map"
		resultType="java.util.HashMap">
		WITH DATES AS (
		SELECT TRUNC(SYSDATE) - LEVEL + 1 AS "date" FROM DUAL CONNECT BY <![CDATA[ LEVEL <= #{days, jdbcType=INTEGER} ]]>
		),
		RETURNING_USERS AS (
		SELECT
		TRUNC(G.LOG_DATE) AS "log_day",
		COUNT(DISTINCT G.MEM_NO) AS "user_count"
		FROM GAME_LOG G
		JOIN MEMBER M ON G.MEM_NO = M.MEM_NO
		WHERE G.LOG_DATE >= TRUNC(SYSDATE) - #{days, jdbcType=INTEGER} + 1
		AND TRUNC(G.LOG_DATE) != TRUNC(M.CREATED_DATE)
		GROUP BY TRUNC(G.LOG_DATE)
		)
		SELECT
		TO_CHAR(D."date", 'MM-DD') AS "LABEL",
		NVL(RU."user_count", 0) AS "VALUE"
		FROM DATES D
		LEFT JOIN RETURNING_USERS RU ON D."date" = RU."log_day"
		ORDER BY D."date" ASC
	</select>

	<select id="getPlaytimeHeatmap" parameterType="java.util.Map"
		resultType="java.util.HashMap">
		SELECT
		TO_CHAR(LOG_DATE, 'DY') AS "DAY_OF_WEEK",
		TO_CHAR(LOG_DATE, 'HH24') AS "HOUR_OF_DAY",
		COUNT(*) AS "COUNT"
		FROM GAME_LOG
		WHERE LOG_DATE >= TRUNC(SYSDATE) - #{days, jdbcType=INTEGER} + 1
		GROUP BY TO_CHAR(LOG_DATE, 'DY'), TO_CHAR(LOG_DATE, 'HH24')
	</select>


</mapper>