<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <!-- 글 INSERT (PK는 트리거), AFTER에 CURRVAL로 회수 -->
<mapper namespace="mappers.reviewMapper">

  <insert id="insertBoard" parameterType="com.our_middle_project.dto.ReviewDTO">
    <selectKey keyProperty="boardNo" resultType="int" order="AFTER">
      SELECT SEQ_BOARD.CURRVAL FROM DUAL
    </selectKey>
      INSERT INTO BOARD (
      BOARD_TITLE, BOARD_CONTENT, CREATED_DATE, UPDATED_DATE, MEM_NO, TYPE_NO) 
      VALUES ('[리뷰]', #{boardContent, jdbcType=VARCHAR}, SYSDATE, SYSDATE, #{memNo}, 2)
  </insert>

  <!-- 이미지 INSERT (FILE_DATA는 NULL 저장) -->
  <!-- BOARD_IMAGE INSERT (파일 메타 저장; FILE_NO는 트리거) -->

  <insert id="insertImage" parameterType="com.our_middle_project.dto.FileImageDTO">
    <selectKey keyProperty="fileNo" resultType="int" order="AFTER">
      SELECT SEQ_BOARD_IMAGE.CURRVAL FROM DUAL
    </selectKey>
    INSERT INTO BOARD_IMAGE (
      FILE_NAME, FILE_DATA, FILE_PATH, FILE_SIZE, FILE_TYPE,
      UPLOAD_DATE, TYPE_NO, BOARD_NO
    ) VALUES (
      #{fileName}, NULL, #{filePath}, #{fileSize}, #{fileType},
      SYSDATE, 2, #{boardNo}
    )
  </insert>

  <insert id="insertAuthorStar" parameterType="map">
    <selectKey keyProperty="starNo" resultType="int" order="AFTER">
      SELECT SEQ_BOARD_STAR.CURRVAL FROM DUAL
    </selectKey>
    INSERT INTO BOARD_STAR (
    	STAR, 
    	CREATED_DATE, 
    	UPDATED_DATE, 
    	MEM_NO, 
    	BOARD_NO
   	)
    VALUES (
    	#{star}, 
    	SYSDATE, 
    	SYSDATE, 
    	#{memNo}, 
    	#{boardNo}
   	)
  </insert>

    <!-- 완료 화면 조회 -->
	<select id="selectReview" parameterType="map"
		resultType="com.our_middle_project.dto.ReviewDTO">
		SELECT
		B.BOARD_NO AS boardNo,
		B.MEM_NO AS memNo,
		M.NICKNAME AS nickName,
		M.MEM_ID AS memId,
		B.BOARD_CONTENT AS boardContent,
		TO_CHAR(B.CREATED_DATE,'YYYY-MM-DD HH24:MI:SS') AS createdDate,
		TO_CHAR(B.UPDATED_DATE,'YYYY-MM-DD HH24:MI:SS') AS updatedDate,
		/* 별점 */
		NVL((
		SELECT S.STAR
		FROM BOARD_STAR S
		WHERE S.BOARD_NO = B.BOARD_NO
		AND S.MEM_NO = B.MEM_NO
		FETCH FIRST 1 ROWS ONLY
		), 0) AS star,
		/* 대표 썸네일(첫 이미지 경로) */
		NVL((
		SELECT I.FILE_PATH
		FROM BOARD_IMAGE I
		WHERE I.BOARD_NO = B.BOARD_NO
		FETCH FIRST 1 ROWS ONLY
		),'') AS firstImagePath
		FROM BOARD B
		JOIN MEMBER M ON M.MEM_NO = B.MEM_NO
		WHERE B.TYPE_NO = 2
		ORDER BY B.BOARD_NO DESC
		FETCH FIRST #{limit} ROWS ONLY
	</select>
	
</mapper>